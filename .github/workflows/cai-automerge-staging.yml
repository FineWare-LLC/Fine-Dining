name: CAI Auto-merge to staging

on:
  pull_request:
    types: [labeled, synchronize, reopened, ready_for_review]
    branches: [staging]

permissions:
  contents: write
  pull-requests: write

concurrency:
  group: cai-automerge-${{ github.event.pull_request.number }}
  cancel-in-progress: true

jobs:
  automerge:
    runs-on: ubuntu-latest

    # Only CAI PRs with explicit merge-ok label.
    if: |
      (startsWith(github.event.pull_request.title, 'CAI') || contains(join(github.event.pull_request.labels.*.name, ','), 'CAI'))
      && contains(join(github.event.pull_request.labels.*.name, ','), 'CAI:merge-ok')
      && github.event.pull_request.draft == false

    steps:
      - name: Check PR status via GitHub API
        id: pr
        uses: actions/github-script@v7
        with:
          script: |
            const pr = context.payload.pull_request;
            const { owner, repo } = context.repo;
            // Query combined status + check runs for the PR head SHA
            const sha = pr.head.sha;

            const checks = await github.rest.checks.listForRef({ owner, repo, ref: sha });
            const statuses = await github.rest.repos.getCombinedStatusForRef({ owner, repo, ref: sha });

            const failingChecks = checks.data.check_runs.filter(r => r.conclusion && r.conclusion !== 'success' && r.conclusion !== 'neutral' && r.conclusion !== 'skipped');
            const pendingChecks = checks.data.check_runs.filter(r => !r.conclusion);

            const state = statuses.data.state; // success | pending | failure

            core.setOutput('sha', sha);
            core.setOutput('combined_state', state);
            core.setOutput('failing_checks', JSON.stringify(failingChecks.map(r => ({ name: r.name, conclusion: r.conclusion }))));
            core.setOutput('pending_count', String(pendingChecks.length));

      - name: Fail if checks not green
        if: steps.pr.outputs.combined_state != 'success' || steps.pr.outputs.pending_count != '0'
        run: |
          echo "Not merging: combined_state=${{ steps.pr.outputs.combined_state }} pending=${{ steps.pr.outputs.pending_count }}"
          echo "Failing checks: ${{ steps.pr.outputs.failing_checks }}"
          exit 1

      - name: Merge PR (squash) into staging
        uses: actions/github-script@v7
        with:
          script: |
            const pr = context.payload.pull_request;
            const { owner, repo } = context.repo;
            await github.rest.pulls.merge({
              owner,
              repo,
              pull_number: pr.number,
              merge_method: 'squash'
            });
